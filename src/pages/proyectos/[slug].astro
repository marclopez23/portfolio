---
// src/pages/proyectos/[slug].astro
import { getCollection, type CollectionEntry } from "astro:content";
import PageLayout from "../../layouts/PageLayout.astro";
import Hero from "../../components/Hero.astro";
import Title from "../../components/Title.astro";
import ProjectThumbnail from "../../components/ProjectThumbnail.astro";
import TextBlock from "../../components/TextBlock.astro";
import SkeletonImage from "../../components/SkeletonImage.astro";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}


const { project } = Astro.props as { project: CollectionEntry<"projects"> };

const {
  title,
  heroImage,
  logo,
  objective,
  role,
  duration,
  team,
  process,
  challenges,
  projectVideo,
  videoThumbnail,
  relatedProjects,
  description,
} = project.data;

// Obtener proyectos relacionados
let relatedProjectsData: CollectionEntry<"projects">[] = [];
if (relatedProjects && relatedProjects.length > 0) {
  const allProjects = await getCollection("projects");
  relatedProjectsData = allProjects.filter(
    (p) => relatedProjects.includes(p.slug) && p.data.protected !== true
  );
}

const pageTitle = `${title} - Marc López`;

function getUrl(path: string): string {
  const cleanPath = path.startsWith('/') ? path.slice(1) : path;
  return `${import.meta.env.BASE_URL}/${cleanPath}`;
}
---

<PageLayout
  title={pageTitle}
  currentPage="/projects"
  description={description}
  keywords={`proyecto ${title}, UX UI design, caso de estudio, Marc López`}
>
  <!-- Project Hero Section -->
  <!-- Hero Section -->
  <section role="banner" aria-labelledby="hero-title">
    <Hero title={title} titleTag="h1" class="fade-in" id="hero-title" />
  </section>
  <section
    class="section project-hero"
    id="hero"
    role="banner"
    aria-labelledby="project-title"
  >
    <div class="container">
      <div class="project-hero__content project-hero__image-container">
        <!-- Project Hero Image -->
        <SkeletonImage
  src={getUrl(heroImage)}
  alt={`Vista principal del proyecto ${title}`}
  class="project-hero__image"
  loading="eager"
  decoding="sync"
/>
    </div>
  </section>

  <!-- Project Information Section -->
  <section
    class="section section--with-border"
    id="project-info"
    role="region"
    aria-labelledby="project-info-title"
  >
    <div class="container">
      <div class="content-block with-logo">
        <Title
          text="Información del proyecto"
          size="big"
          showDivider={false}
          as="h2"
          id="project-info-title"
        />

        {
          logo && (
            <img
              src={getUrl(logo)}
              alt={`Logo de ${title}`}
              class="project-hero__logo"
              loading="lazy"
              decoding="async"
            />
          )
        }

        <div class="project-info">
          <TextBlock
            title="Objetivo"
            description={objective}
            size="sm"
            titleTag="h4"
          />
          <TextBlock title="Rol" description={role} size="sm" titleTag="h4" />

          <TextBlock
            title="Duración"
            description={duration}
            size="sm"
            titleTag="h4"
          />

          <TextBlock
            title="Equipo de diseño"
            description={team}
            size="sm"
            titleTag="h4"
          />
        </div>
      </div>
    </div>
  </section>

  <!-- Process Section -->
  {
    process && (
      <section
        class="section section--with-border"
        id="process"
        role="region"
        aria-labelledby="process-title"
      >
        <div class="container">
          <div class="content-block">
            <Title
              text={process.title}
              size="big"
              showDivider={false}
              as="h2"
              id="process-title"
            />

            <div class="process-content">
              <div class="process-content__text">
                <div class="process-text auto-sentences" set:html={process.content} />
              </div>
              {process.image && (
                <div class="process-content__image">
                  <img
                    src={getUrl(process.image)}
                    alt={`Proceso del proyecto ${title}`}
                    class="process-image"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              )}
            </div>
          </div>
        </div>
      </section>
    )
  }

  <!-- Challenges Section -->
  {
    challenges && challenges.items && challenges.items.length > 0 && (
      <section
        class="section section--with-border"
        id="challenges"
        role="region"
        aria-labelledby="challenges-title"
      >
        <div class="container">
          <div class="content-block">
            <Title
              text={challenges.title}
              size="big"
              showDivider={false}
              as="h2"
              id="challenges-title"
            />

            <div class="challenges-list">
              {challenges.items.map((challenge, index) => (
                <div
                  class={`challenge challenge--${challenge.layout}`}
                  role="article"
                  aria-labelledby={`challenge-${index}-title`}
                >
                  <div class="challenge__content">
                    <TextBlock
                      title={challenge.title}
                      description={challenge.content}
                      size="xl"
                      titleTag="h3"
                      class="challenge__content"
                    />
                  </div>

                  {challenge.image && (
                    <div class="challenge__media">
                      <SkeletonImage
  src={getUrl(challenge.image)}
  alt={`Ilustración de ${challenge.title}`}
  class="challenge__image"
  loading="lazy"
  decoding="async"
/>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>
    )
  }

  <!-- Project Video Section -->
  {
    projectVideo && (
      <section
        class="section section--with-border"
        id="project-video"
        role="region"
        aria-labelledby="video-title"
      >
        <div class="container">
          <div class="content-block">
            <Title
              text="Video del proyecto"
              size="big"
              showDivider={false}
              as="h2"
              id="video-title"
            />

            <div class="project-video">
              <!-- Thumbnail clickeable en lugar de video directo -->
              <div 
                class="video-thumbnail"
                data-video-src={getUrl(projectVideo)}
                data-video-title={`Video completo del proyecto ${title}`}
              >
                <SkeletonImage
  src={getUrl(videoThumbnail) || getUrl(heroImage) || '/placeholder-video.jpg'}
  alt={`Video completo del proyecto ${title}`}
  class="video-poster"
  loading="lazy"
  decoding="async"
/>
                <div class="video-play-button">
                  <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
                    <circle cx="40" cy="40" r="40" fill="rgba(255, 255, 255, 0.95)"/>
                    <path d="M52 40L32 52V28L52 40Z" fill="#000"/>
                  </svg>
                </div>
                <div class="video-overlay">
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    )
  }

  <!-- Related Projects Section -->
  {
    relatedProjectsData && relatedProjectsData.length > 0 && (
      <section
        class="section"
        id="related-projects"
        role="region"
        aria-labelledby="related-projects-title"
      >
        <div class="container">
          <div class="content-block">
            <Title
              text="Otros proyectos"
              size="big"
              showDivider={false}
              as="h2"
              id="related-projects-title"
            />

            <div class="related-projects">
              {relatedProjectsData.map((relatedProject) => (
                <div class="related-project">
                  <ProjectThumbnail
                    title={relatedProject.data.title}
                    linkText="Ver proyecto"
                    href={getUrl(`proyectos/${relatedProject.slug}`)}
                    imageSrc={getUrl(relatedProject.data.heroImage)}
                    imageAlt={`Vista previa del proyecto ${relatedProject.data.title}`}
                    variant="medium"
                    ariaLabel={`Ver detalles del proyecto ${relatedProject.data.title}`}
                  />
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>
    )
  }

  <!-- Modal para video fullscreen -->
  <div id="video-modal" class="video-modal">
    <div class="video-modal-content">
      <button class="video-modal-close" aria-label="Cerrar video">&times;</button>
      <video 
        id="modal-video"
        class="modal-video"
        controls
        preload="none"
      >
        <p>Tu navegador no soporta el elemento video.</p>
      </video>
    </div>
  </div>

</PageLayout>

<style>
  /* Importar estilos globales de layout */
  @import "../../styles/layout.css";

  /* ====================================
     PROJECT HERO SECTION
     ====================================  */

  .project-hero {
    padding-top: 0px;
  }

  .project-hero__content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2xl);
    align-items: center;
    text-align: center;
  }

  .project-hero__image-container {
    width: 100%;
    border-radius: var(--radius-xl);
    overflow: hidden;
    background-color: var(--color-surface);
  }

  .project-hero__image {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  .project-hero__info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-lg);
  }

  .project-hero__logo {
    height: 60px;
    width: auto;
    object-fit: contain;
  }

  .project-hero__title {
    font-family: var(--font-family-primary);
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin: 0;
    line-height: var(--line-height-normal);
  }

  /* ====================================
     PROJECT INFORMATION SECTION
     ====================================  */

  .project-info {
    display: grid;
    gap: var(--spacing-2xl);
    grid-template-columns: 1fr;
  }

  .with-logo {
    align-items: flex-start;
  }

  /* ====================================
     PROCESS SECTION
     ====================================  */

  .process-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2xl);
  }

  .process-content__image {
    order: 1;
  }

  .process-content__text {
    order: 2;
  }

  .process-image {
    width: 100%;
    height: auto;
    border-radius: var(--radius-lg);
    object-fit: cover;
  }

  .process-text {
    font-family: var(--font-family-primary);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-regular);
    color: var(--color-text-secondary);
    line-height: var(--line-height-normal);
    margin: 0;
  }

  .process-text p {
  margin: 0 0 1em 0;
  line-height: 1.6;
}

.process-text p:last-child {
  margin-bottom: 0;
}

.process-text p:first-child {
  margin-top: 0;
}


  /* ====================================
     CHALLENGES SECTION
     ====================================  */

  .challenges-list {
    display: flex;
    flex-direction: column;
    gap: var(--section-gap);
  }

  .challenge {
    display: flex;
    flex-direction: column;
    gap: var(--section-gap);
    padding-top: var(--spacing-2xl);
  }

  .challenge__content {
    order: 2;
  }

  .challenge__media {
    order: 1;
  }

  .challenge__title {
    font-family: var(--font-family-primary);
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--spacing-lg) 0;
    line-height: var(--line-height-normal);
  }

  .challenge__text {
    font-family: var(--font-family-primary);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-regular);
    color: var(--color-text-secondary);
    line-height: var(--line-height-normal);
  }

  .challenge__text p {
    margin: 0 0 var(--spacing-lg) 0;
  }

  .challenge__text p:last-child {
    margin-bottom: 0;
  }

  /* ====================================
     VIDEO THUMBNAIL STYLES
     ====================================  */

  .video-thumbnail {
    position: relative;
    cursor: pointer;
    display: block;
    transition: transform 0.3s ease;
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .video-thumbnail:hover {
    transform: scale(1.02);
  }

  .video-poster {
    width: 100%;
    height: auto;
    display: block;
  }

  .video-play-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    transition: transform 0.3s ease;
    z-index: 2;
  }

  .video-thumbnail:hover .video-play-button {
    transform: translate(-50%, -50%) scale(1.1);
  }

  .video-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    color: white;
    padding: 24px 16px 16px;
    text-align: center;
  }

  .video-overlay p {
    margin: 0;
    font-size: 14px;
    opacity: 0.9;
  }

  .challenge__image {
    width: 100%;
    height: auto;
    border-radius: var(--radius-lg);
    object-fit: cover;
  }

  /* ====================================
     PROJECT VIDEO SECTION
     ====================================  */

  .project-video {
    display: flex;
    justify-content: center;
  }

  .project-video .video-thumbnail {
    width: 100%;
  }

  /* ====================================
     RELATED PROJECTS SECTION
     ====================================  */

  .related-projects {
    display: grid;
    gap: var(--spacing-2xl);
    grid-template-columns: 1fr;
  }

  /* ====================================
     VIDEO MODAL STYLES
     ====================================  */

  .video-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    align-items: center;
    justify-content: center;
  }

  .video-modal-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-video {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
  }

  .video-modal-close {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 40px;
    font-weight: bold;
    border: none;
    background: none;
    cursor: pointer;
    z-index: 10001;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.5);
    transition: background-color 0.3s ease;
  }

  .video-modal-close:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  /* ====================================
     DESKTOP RESPONSIVE
     ====================================  */

  @media (min-width: 768px) {
    .project-hero__title {
      font-size: var(--font-size-4xl);
    }

    .project-hero__logo {
      height: 80px;
    }

    /* Project info in 4 columns on desktop */

    .with-logo {
      align-items: flex-start;
    }

    .project-info {
      grid-template-columns: repeat(4, 1fr);
      gap: var(--spacing-3xl);
    }

    /* Process section desktop layout */
    .process-content {
      flex-direction: row;
      align-items: flex-start;
      gap: var(--spacing-4xl);
    }

    .process-content__image {
      order: 2;
      flex: 0 0 40%;
    }

    .process-content__text {
      order: 1;
      flex: 1;
    }

    .process-text {
      font-size: var(--font-size-md);
      column-count: 2;
      column-gap: var(--section-gap);
    }


    /* Challenges desktop layouts */

    .challenge {
      display: grid;
      flex-direction: column;
      grid-template-columns: 1fr 1fr;
    }

    .challenge--image-left {
      flex-direction: row;
      align-items: center;
    }

    .challenge--image-left .challenge__media {
      order: 1;
      flex: 0 0 50%;
    }

    .challenge--image-left .challenge__content {
      order: 2;
      flex: 1;
    }

    .challenge--image-right {
      flex-direction: row;
      align-items: center;
    }

    .challenge--image-right .challenge__media {
      order: 2;
      flex: 0 0 50%;
    }

    .challenge--image-right .challenge__content {
      order: 1;
      flex: 1;
    }

    .challenge--full-width .challenge__media {
      order: 1;
    }

    .challenge--full-width .challenge__content {
      order: 2;
    }

    .challenge__title {
      font-size: var(--font-size-3xl);
    }

    .challenge__text {
      font-size: var(--font-size-xl);
    }

    /* Related projects grid */
    .related-projects {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-3xl);
    }

    .video-modal-close {
      top: 20px;
      right: 30px;
      font-size: 40px;
      width: 50px;
      height: 50px;
    }
  }

  /* Mobile adjustments */
  @media (max-width: 768px) {
    .video-modal-close {
      top: 10px;
      right: 15px;
      font-size: 30px;
      width: 40px;
      height: 40px;
    }

    section#hero {
      padding: 0;
}

.project-hero__image-container{
  border-radius: 0;
}

.project-hero__image{
  height: 300px;
}



  }

  /* ====================================
     ACCESSIBILITY & MOTION
     ====================================  */

  /* Reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .challenge,
    .process-content {
      transition: none;
    }
  }

  /* High contrast mode improvements */
  @media (prefers-contrast: high) {
    .project-hero__image-container,
    .process-image,
    .challenge__image {
      outline: 2px solid var(--color-text-primary);
      outline-offset: 2px;
    }
  }

  /* Touch device improvements */
  @media (hover: none) and (pointer: coarse) {
    .challenge {
      gap: var(--spacing-2xl);
    }

    .process-content {
      gap: var(--spacing-2xl);
    }
  }
</style>

<script is:inline>
  function convertToSentences() {
    document.querySelectorAll('.auto-sentences').forEach(element => {
      const text = element.textContent?.trim();
      
      if (!text) return;
      
      const sentences = text.split(/\.\s+(?=[A-Z])/)
        .filter(s => s.trim())
        .map(s => s.trim().endsWith('.') ? s.trim() : s.trim() + '.');
      
      if (sentences.length > 1) {
        element.innerHTML = sentences.map(s => 
          `<p style="margin: 0 0 1em 0; line-height: 1.6;">${s}</p>`
        ).join('');
        
        // Quitar margen del último
        const lastP = element.querySelector('p:last-child');
        if (lastP) lastP.style.marginBottom = '0';
        
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', convertToSentences);
  document.addEventListener('astro:page-load', convertToSentences);
</script>

<script is:inline>
  function setupVideoModal() {
    const modal = document.getElementById('video-modal');
    const modalVideo = document.getElementById('modal-video');
    const closeBtn = document.querySelector('.video-modal-close');
    
    // Hacer clickeables todos los thumbnails de video
    document.querySelectorAll('.video-thumbnail').forEach(thumbnail => {
      thumbnail.addEventListener('click', function() {
        const videoSrc = this.dataset.videoSrc;
        const videoTitle = this.dataset.videoTitle;
        
        // Configurar video del modal
        modalVideo.src = videoSrc;
        modalVideo.load();
        
        // Mostrar modal
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Solo reproducir automáticamente (SIN fullscreen)
        modalVideo.play().catch(err => {
          console.log('Autoplay no disponible:', err);
        });
      });
    });
    
    // Cerrar modal
    function closeModal() {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
      
      // Pausar y resetear el video
      modalVideo.pause();
      modalVideo.currentTime = 0; // Volver al inicio
      modalVideo.src = '';
      
      // Salir de fullscreen si estaba activo
      if (document.fullscreenElement) {
        document.exitFullscreen();
      }
    }
    
    closeBtn?.addEventListener('click', closeModal);
    
    modal?.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeModal();
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', setupVideoModal);
  document.addEventListener('astro:page-load', setupVideoModal);
</script>