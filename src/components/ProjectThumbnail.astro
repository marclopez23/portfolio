---
// src/components/ProjectThumbnail.astro
import Link from './Link.astro';

export interface Props {
  title?: string;
  imageSrc?: string;
  imageAlt?: string;
  variant?: 'big' | 'medium' | 'small';
  href?: string;
  target?: '_blank' | '_self';
  linkText?: string;
  ariaLabel?: string;
  class?: string;
  loading?: 'eager' | 'lazy';
  showSkeleton?: boolean;
}

const {
  title = "Nombre del proyecto",
  imageSrc = "https://via.placeholder.com/400x300/F5E6D3/000000?text=Preview",
  imageAlt = "Vista previa del proyecto",
  variant = "medium",
  href = "#",
  target = "_self",
  linkText = "Ver m치s",
  ariaLabel,
  class: className = "",
  loading = "lazy",
  showSkeleton = false,
} = Astro.props;

const baseClasses = "project-thumbnail";
const variantClass = `project-thumbnail--${variant}`;
const skeletonClass = showSkeleton ? "project-thumbnail--skeleton" : "";
const allClasses = [baseClasses, variantClass, skeletonClass, className].filter(Boolean).join(" ");

// Dimensiones optimizadas por variante
const dimensionsByVariant = {
  big: { width: 982, height: 600 },     // Para homepage
  medium: { width: 400, height: 250 },  // Para grids normales
  small: { width: 300, height: 200 },   // Para related projects
};

const { width, height } = dimensionsByVariant[variant];

// ID 칰nico para el componente
const componentId = `project-thumbnail-${Math.random().toString(36).substr(2, 9)}`;
---

<article class={allClasses} id={componentId}>
  <!-- Imagen clickeable -->
  <a 
    href={href}
    target={target}
    class="project-thumbnail__image-link"
    aria-label={ariaLabel || `Ver proyecto ${title}`}
  >
    <div class="project-thumbnail__image-container">
      <!-- Skeleton placeholder -->
      <div class="project-thumbnail__skeleton" aria-hidden="true">
        <div class="skeleton-shimmer"></div>
      </div>
      
      <!-- Imagen real -->
      <img 
        src={imageSrc}
        alt={imageAlt}
        class="project-thumbnail__image"
        width={width}
        height={height}
        loading={loading}
        decoding="async"
        onload={`
          const thumbnail = document.getElementById('${componentId}');
          if (thumbnail) thumbnail.classList.add('image-loaded');
        `}
        onerror={`
          const thumbnail = document.getElementById('${componentId}');
          if (thumbnail) thumbnail.classList.add('image-error');
        `}
      />
    </div>
  </a>
  
  <div class="project-thumbnail__content">
    <h3 class="project-thumbnail__title">{title}</h3>
    <Link 
      text={linkText}
      href={href}
      target={target}
      ariaLabel={ariaLabel}
      class="project-thumbnail__link"
    />
  </div>
</article>

<style>
  .project-thumbnail {
    position: relative;
    width: 100%;
  }
  
  /* ========================================
     IMAGEN CLICKEABLE
     ======================================== */
  
  .project-thumbnail__image-link {
    display: block;
    text-decoration: none;
    border-radius: var(--radius-xl);
    overflow: hidden;
    transition: transform 0.2s ease-in-out;
  }

  /* SOLUCI칍N: Eliminar borde rojo al hacer click */
  .project-thumbnail__image-link:focus {
    outline: none; /* Eliminar outline por defecto */
  }

  .project-thumbnail__image-link:focus-visible {
    outline: 3px solid var(--color-text-tertiary);
    outline-offset: 2px;
  }

  /* Hover effect en el enlace */
  .project-thumbnail__image-link:hover {
    transform: translateY(-2px);
  }

  .project-thumbnail__image-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: var(--radius-xl);
    background-color: #F5E6D3;
    margin-bottom: var(--spacing-lg);
  }
  
  /* ========================================
     SKELETON LOADING
     ======================================== */

  .project-thumbnail__skeleton {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, #d1d5db 25%, #9ca3af 50%, #d1d5db 75%);
    background-size: 200% 100%;
    border-radius: var(--radius-xl);
    z-index: 1;
    opacity: 1;
    transition: opacity 0.3s ease-in-out;
  }

  /* Animaci칩n del skeleton */
  .skeleton-shimmer {
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent 25%,
      rgba(255, 255, 255, 0.5) 50%,
      transparent 75%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 2s infinite;
  }

  @keyframes skeleton-loading {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }

  /* Estados de carga */
  .project-thumbnail .project-thumbnail__skeleton {
    opacity: 1; /* Por defecto visible */
  }

  .project-thumbnail .project-thumbnail__image {
    opacity: 0; /* Por defecto oculta */
    transition: opacity 0.3s ease-in-out;
  }

  .project-thumbnail.image-loaded .project-thumbnail__skeleton {
    opacity: 0;
    pointer-events: none;
  }

  .project-thumbnail.image-loaded .project-thumbnail__image {
    opacity: 1; /* Se muestra cuando carga */
  }

  .project-thumbnail.image-error .project-thumbnail__skeleton {
    background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
  }

  .project-thumbnail.image-error .project-thumbnail__skeleton::after {
    content: '游닞';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    opacity: 0.7;
  }

  /* Skeleton forzado */
  .project-thumbnail--skeleton .project-thumbnail__skeleton {
    opacity: 1;
  }

  .project-thumbnail--skeleton .project-thumbnail__image {
    opacity: 0;
  }
  
  /* ========================================
     IMAGEN
     ======================================== */

  .project-thumbnail__image {
    position: relative;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    z-index: 2;
  }

  /* Hover effect en la imagen */
  .project-thumbnail__image-link:hover .project-thumbnail__image {
    transform: scale(1.02);
  }

  /* ========================================
     CONTENIDO
     ======================================== */

  .project-thumbnail__content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  /* Big variant: t칤tulo y enlace en la misma fila */
  .project-thumbnail--big .project-thumbnail__content {
    flex-direction: row;
    justify-content: space-between;
    align-items: baseline;
    gap: var(--spacing-lg);
  }
  
  .project-thumbnail__title {
    font-family: var(--font-family-primary);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin: 0;
    line-height: var(--line-height-normal);
    
    /* Truncate text - m치ximo 2 l칤neas */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Big variant: solo 1 l칤nea de texto */
  .project-thumbnail--big .project-thumbnail__title {
    -webkit-line-clamp: 1;
  }

  /* Tama침os de t칤tulo por variante */
  .project-thumbnail--big .project-thumbnail__title {
    font-size: var(--font-size-3xl);
  }
  
  .project-thumbnail--medium .project-thumbnail__title {
    font-size: var(--font-size-2xl);
  }
  
  .project-thumbnail--small .project-thumbnail__title {
    font-size: var(--font-size-xl);
  }

  /* ========================================
     ASPECT RATIOS
     ======================================== */

  .project-thumbnail--big .project-thumbnail__image-container {
    aspect-ratio: 16 / 9;
  }
  
  .project-thumbnail--medium .project-thumbnail__image-container {
    aspect-ratio: 16 / 10;
  }
  
  .project-thumbnail--small .project-thumbnail__image-container {
    aspect-ratio: 16 / 11;
  }

  /* ========================================
     RESPONSIVE
     ======================================== */

  /* Mobile adjustments */
  @media (max-width: 767px) {
    .project-thumbnail__image-container {
      margin-bottom: var(--spacing-md);
    }

    .project-thumbnail__content {
      gap: var(--spacing-sm);
    }

    /* Mobile: todos los tama침os m치s peque침os */
    .project-thumbnail--big .project-thumbnail__title,
    .project-thumbnail--medium .project-thumbnail__title,
    .project-thumbnail--small .project-thumbnail__title {
      font-size: var(--font-size-lg);
    }

    /* Mobile: todos los enlaces van abajo */
    .project-thumbnail--big .project-thumbnail__content {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-sm);
    }

    /* Mobile: aspect ratios m치s cuadrados */
    .project-thumbnail--big .project-thumbnail__image-container {
      aspect-ratio: 16 / 10;
    }
    
    .project-thumbnail--medium .project-thumbnail__image-container {
      aspect-ratio: 16 / 11;
    }
    
    .project-thumbnail--small .project-thumbnail__image-container {
      aspect-ratio: 16 / 12;
    }

    /* Mobile: hover m치s sutil */
    .project-thumbnail__image-link:hover {
      transform: translateY(-1px);
    }
  }

  /* Desktop adjustments */
  @media (min-width: 768px) {
    .project-thumbnail__image-container {
      margin-bottom: var(--spacing-xl);
    }

    .project-thumbnail__content {
      gap: var(--spacing-md);
    }
  }

  /* ========================================
     ACCESSIBILITY
     ======================================== */

  @media (prefers-reduced-motion: reduce) {
    .project-thumbnail__image,
    .project-thumbnail__image-link,
    .project-thumbnail__skeleton {
      transition: none;
    }
    
    .project-thumbnail__image-link:hover {
      transform: none;
    }

    .project-thumbnail__image-link:hover .project-thumbnail__image {
      transform: none;
    }

    .skeleton-shimmer {
      animation: none;
    }
  }

  /* High contrast mode */
  @media (prefers-contrast: high) {
    .project-thumbnail__image-container {
      border: 2px solid var(--color-text-primary);
    }

    .project-thumbnail__image-link:focus-visible {
      outline: 3px solid var(--color-text-primary);
    }
  }

  /* ========================================
     TOUCH DEVICES
     ======================================== */

  @media (hover: none) and (pointer: coarse) {
    .project-thumbnail__image-link:hover {
      transform: none;
    }

    .project-thumbnail__image-link:hover .project-thumbnail__image {
      transform: none;
    }

    /* Touch feedback */
    .project-thumbnail__image-link:active {
      transform: scale(0.98);
    }
  }
</style>

<script>
  // JavaScript para manejar el skeleton loading
  document.addEventListener('DOMContentLoaded', function() {
    const thumbnails = document.querySelectorAll('.project-thumbnail');
    
    thumbnails.forEach(thumbnail => {
      const img = thumbnail.querySelector('.project-thumbnail__image') as HTMLImageElement;
      
      if (img) {
        // Si la imagen ya est치 cargada (desde cache)
        if (img.complete && img.naturalHeight !== 0) {
          thumbnail.classList.add('image-loaded');
        } else {
          // Forzar skeleton visible
          thumbnail.classList.remove('image-loaded');
        }
      }
    });
  });

  // Para Astro page transitions
  document.addEventListener('astro:page-load', function() {
    const thumbnails = document.querySelectorAll('.project-thumbnail');
    
    thumbnails.forEach(thumbnail => {
      const img = thumbnail.querySelector('.project-thumbnail__image') as HTMLImageElement;
      
      if (img) {
        if (img.complete && img.naturalHeight !== 0) {
          thumbnail.classList.add('image-loaded');
        } else {
          thumbnail.classList.remove('image-loaded');
        }
      }
    });
  });
</script>